{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sliding Tile Puzzle</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
</head>

<body>
    <form action="{% url 'landing' %}" method="get">
        <button type="submit" id="back-button" class="back-button">Back</button>
    </form>
    
    <div id="game-board"></div>
    
    <div id="button-container">
        <div></div>
        <button id="move-up" class="make-move-button" data-direction="1">Up</button>
        <div></div>
        
        <button id="new-game-button" class="control-button">New Game</button>
        <button id="move-left" class="make-move-button" data-direction="3">Left</button>
        <button id="move-right" class="make-move-button" data-direction="2">Right</button>
        <button id="auto-solve-button" class="control-button">Auto-solve</button>

        <div></div>
        <button id="move-down" class="make-move-button" data-direction="0">Down</button>
        <div></div>
    </div>
    
    <div id="message-text" style="display: none;"> </div>

    <script>
        // Note: board data is loaded dynamically, so you can usually ignore unresolved variables relating to board
        
        // Global variables for rows and cols
        let rows = {{ rows }};
        let cols = {{ cols }};
        let gameActive = true; 

        $(document).ready(function() {
            // Immediately initialize the game upon page load
            initializeGame(rows, cols);

            // Movement buttons
            $('.make-move-button').click(function() {
                let direction = $(this).data('direction');
                makeMove(direction);
            });

            // Allow manual moving with arrow keys
            $(document).keydown(function(e) {
                if (!gameActive) return;
                let directionMap = { 'ArrowDown': 0, 'ArrowUp': 1, 'ArrowRight': 2, 'ArrowLeft': 3 };
                let direction = directionMap[e.key];
                if (direction !== undefined) {
                    makeMove(direction);
                }
            });
        });

        function initializeGame(rows, cols) {
            $.getJSON('/start/', { 'rows': rows, 'cols': cols }, function(data) {
                updateBoard(data.board);
                $('#game-board').css('display', 'grid');
            });
        }

        function makeMove(direction) {
            if (!gameActive) return;

            const directionToButtonId = {
                0: "#move-down",
                1: "#move-up",
                2: "#move-right",
                3: "#move-left"
            };
        
            let $button = $(directionToButtonId[direction]);
        
            $.getJSON('/move/', { 'direction': direction, 'rows': rows, 'cols': cols }, function(data) {
                if (data.success) {
                    // Hide and clear existing message text
                    $("#message-text").hide().empty();
                    updateBoard(data.board);
                    
                    // Fancy color fade when moved
                    $button.stop(true, true).css("background-color", "#00ff00").delay(100).animate({ backgroundColor: "" }, 100);
                    
                    if (data.solved) {
                        $("#message-text").text("Puzzle solved!").css("background-color", "#00ff00").show();
                        gameActive = false;
                    }
                } else {
                    $("#message-text").text("Move not possible").css("background-color", "#ff0000").show();
                }
            });
        }

        function updateBoard(board) {
            let boardDiv = $('#game-board').empty().css({
                'display': 'grid',
                'grid-template-columns': `repeat(${cols}, 100px)`
            });
            board.forEach(row => {
                row.forEach(tile => {
                    let tileContent = tile === 0 ? '' : tile; // Show empty space for 0
                    boardDiv.append($('<div class="tile">').text(tileContent));
                });
            });
        }
    </script>
</body>
</html>
